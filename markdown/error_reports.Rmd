---
title: "HFR Error Report"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output: word_document
params:
  filename: "HFR_FY21_DEC_Uganda_20210120"
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r functions, include=FALSE}
is_error <- function(check_name){
  unique(df_err_sbmsn$validation_type) %>% 
    str_detect(check_name) %>% 
    any()
}

count_error <- function(check_name){
  df_err_sbmsn %>% 
    filter(validation_type == check_name) %>% 
    nrow() %>% 
    comma(., 1)
}
```

```{r sbmsn, include=FALSE}

df_err_sbmsn <- df_err %>% 
  filter(file_name == params$filename)

pd <- df_err_sbmsn %>% 
  filter(validation_type != "err_pd_multiple-periods") %>% 
  count(hfr_pd, sort = TRUE) %>%
  slice(n = 1) %>% 
  pull(hfr_pd)

file <- unique(df_err_sbmsn$file_name)
```


### Background

For FY21, HFRG has introduced a few changes to the overall submission process as we migrate to a new agency system, the Development Data Commons (DDC), that HFR is piloting. Traditionally, HFRG has managed much of the corrections to resolve submission errors we've received to get them into our initial database. Our error reports will evolve in the coming months, but this report provides the status of any issues we're finding and need you to resolve in order to get your HFR `r pd` submission into the database.  

After you resolved the errors in your file detailed below, you will need to resubmit using the Google Form found at https://tinyurl.com/hfr-submission-form. If you have any questions, please reach out to HFRG at oha_hfr@usaid.gov.


### Submission file

`r file`


### Errors to resolve

Any errors highlighted in this section entail that related records of data were not import with your submission. Please review the issues below, resolve those errors aren resubmit via the HFR Google Form.

```{r no_tabs, include=FALSE}
if(is_error("err_tmp_no-valid-tabs")){
  msg_tabs <- glue("**NO VALID TABS ERROR**:
                       The submission contains no tabs that could be imported. Review your submission and ensure that your data tab has 'HFR' in the tab name. No data were imported. Please resubmit after you fix the tab naming.")
}
```

`r if(is_error("err_tmp_no-valid-tabs")){msg_tabs}`


```{r ou, include=FALSE}
if(is_error("err_org_unknown-ou")){
  msg_ou <- glue("**OPERATING UNIT NAME ERROR**:
                       The submission contains {count_error('err_org_unknown-ou')} rows where *operatingunit does not match DATIM exactly*. Check the spelling or, if you are a regional program, that you have written the Operating Unit (e.g. Asia Region) or Country Name (eg Nepal) into column F in your submission. Rows where this does not match DATIM will be excluded.")
}
```

`r if(is_error("err_org_unknown-ou")){msg_ou}`

```{r orgunit, include=FALSE}

if(is_error("err_org_unknown-orgunituid")){
  
  issue_orgunits <- df_err_sbmsn %>%
    filter(validation_type == "err_org_unknown-orgunituid") %>% 
    distinct(orgunit, orgunituid) %>% 
    select(`Site/Community` = orgunit, `Wrong DATIM UID` = orgunituid) %>% 
    arrange(`Site/Community`)
  
  msg_orgunits <- glue("**ORG UNIT UID ERROR**:
                       The submission contains {nrow(issue_orgunits)} of wrong or missing facility/community UIDs (orgunituid) in column C of your submission. These must be resolved or the data will not be included in the HFR database.")
}
```

`r if(is_error("err_org_unknown-orgunituid")){msg_orgunits}`

```{r org_table, echo=FALSE}

if(is_error("err_org_unknown-orgunituid")){
  knitr::kable(issue_orgunits)
}

```


```{r mechcode, include=FALSE}

if(is_error("err_mech_invalid-mech")){
  
  issue_mechs <- df_err_sbmsn %>% 
    filter(validation_type == "err_mech_invalid-mech") %>% 
    distinct(mech_code) %>%
    arrange(mech_code) %>% 
    pull() %>% 
    paste(collapse = ', ')
  
  ou <- df_err_sbmsn %>% 
    filter(validation_type == "err_mech_invalid-mech") %>% 
    distinct(operatingunit) %>% 
    pull() %>% 
    paste(collapse = '/')
  
    msg_mechcode <- glue("**MECH CODE ERROR**:
    The following mechanisms were flagged across {count_error('err_mech_invalid-mech')} rows as not existing in {ou} (sourced from your FY21 site validation in October) and need to be corrected. Rows with a mismatched mech_code will be excluded from our database. Please review the following mismatched mechanisms found in column D of your submission question:   
             {issue_mechs}")
  }
```

`r if(is_error("err_mech_invalid-mech")){msg_mechcode}`

```{r pd, include=FALSE}

if(is_error("err_pd_unknown-date")){
  
  issue_dates <- df_err_sbmsn %>% 
    filter(validation_type == "err_pd_unknown-date") %>% 
    distinct(additional_information) %>%
    arrange(additional_information) %>% 
    mutate(additional_information = 
             case_when(
               additional_information == "Unavailable" ~ "Unknown Format",
               is.na(additional_information) ~ "[Blank]",
               TRUE ~ additional_information)) %>% 
    pull() %>% 
    paste(collapse = ', ')
  
  msg_pd <- glue('**DATE ERROR**:
                 Your file had {count_error("err_pd_unknown-date")} rows with an invalid or unknown date and the reported values have been dropped. Review the date in column A of your submission, ensuring that all dates are (a) in the correct year, (b) the first of the month or a Monday if reporting weekly, or (c) are all formatted the same, ideally as yyyy-mm-dd. To reformat, Highlight all the dates > right click > Format Cells > Custom > Type: yyyy-mm-dd. Please review the following dates found in column A of your submission question:
                 {issue_dates}')
}
```

`r if(is_error("err_pd_unknown-date")){msg_pd}`

```{r multi_pd, include=FALSE}

if(is_error("err_pd_multiple-periods")){
  
  curr_pd <- df_err_sbmsn %>% 
    distinct(fy, hfr_pd)%>% 
    unite(hfr_pd, c(fy, hfr_pd), sep = ".") %>% 
    mutate(hfr_pd = na_if(hfr_pd, "NA.NA")) %>% 
    pull(hfr_pd) %>% 
    paste0(collapse = ", ")
    
  issue_dates <- df_err_sbmsn %>% 
    filter(validation_type == "err_pd_multiple-periods")
    distinct(date)%>% 
    arrange(date) %>% 
    pull(date) %>% 
    paste0(collapse = ", ")
  
  msg_multi <- glue("**MULTIPLE PERIODS ERROR**:
  Submissions must contain only one reporting period/month. Your submission has dates from the following multiple periods. Please amend your column A of your submission to only include the date or dates from this reporting period, {curr_pd}. The dates outside this period included: 
  {issue_dates}")
  
}
```

`r if(is_error("err_pd_multiple-periods")){msg_multi}`


```{r neg_val, include=FALSE}

if(is_error("err_val_negative-value")){
  
   issue_val <- df_err_sbmsn %>% 
    filter(validation_type == "err_val_negative-value") %>% 
    mutate(info = glue("{mech_name} at {orgunit} reporting under {additional_information}"),
           info = str_remove(info, " reporting under NA")) %>% 
    distinct(info)%>% 
    pull(info) %>% 
    paste0(collapse = "\n ")
    
  msg_negval <- glue('**NEGATIVE VALUE ERROR**:
                     Your file had {count_error("err_val_negative-value")} cell(s) with a negative value reported. Review all value columns (column L in the long template or columns H onwards in the wide template) and update your submission, ensuring no cells have negative values. All negative values will otherwise be removed from the dataset. Negative values were found in the following places:
                     {issue_val}')
  
}
```

`r if(is_error("err_val_negative-value")){msg_negval}`

```{r unknown_ind, include=FALSE}

if(is_error("indicator_unknown_or_wrong")){

  msg_ind <- glue('**UNKNOWN INDICATOR WARNING**:
                  This is just a warning that your file had {count_error("indicator_unknown_or_wrong")} rows/cells that did not match an standard HFR indicator. Any indicators beyond the standard seven (HTS_TST, HTS_TST_POS, TX_NEW, TX_CURR, TX_MMD, VMMC_CIRC, PrEP_NEW) will not appear in the HFR Tableau workbooks. Additional indicators are acceptable, but we want to ensure you did not mistype one of the seven HFR indicators.')
  
}
```

`r if(is_error("indicator_unknown_or_wrong")){msg_ind}`


```{r extra_disaggs, include=FALSE}

if(is_error("otherdisaggregate_extras")){
  
  msg_extra <- glue('**NON-STANDARD DISAGGREGATE WARNING**:
                    Your file had {count_error("otherdisaggregate_extras")} rows that did not match an accepted otherdisaggregate value. Any text values in otherdisaggregate other than the following will be replaced with NA: <3 months, 3-5 months, or 6 months or more')
}

```

`r if(is_error("otherdisaggregate_extras")){msg_extra}`